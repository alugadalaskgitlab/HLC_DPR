<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HLC DPR (Mobile Form)</title>

  <!-- PWA bits (unchanged) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root{--bg:#0b1020;--card:#11162a;--muted:#9097b3;--fg:#eaf0ff;--accent:#60a5fa;--ok:#16a34a;--warn:#f59e0b;}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    html,body{margin:0;background:#0b1020;color:var(--fg)}
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 80px}
    h1{font-size:22px;margin:10px 0 14px}
    .card{background:var(--card);border:1px solid #1b2140;border-radius:14px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1 1 180px;display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #25305a;background:#0e1430;color:var(--fg);border-radius:10px}
    textarea{min-height:70px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #1b2140;padding:8px;text-align:left;vertical-align:middle}
    th{font-size:12px;color:var(--muted);font-weight:600}
    tfoot td{font-weight:700}
    .btn{appearance:none;border:1px solid #2a3768;background:#13204d;color:var(--fg);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:#1d4ed8;border-color:#1e3a8a}
    .btn.ghost{background:transparent}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .totals{font-size:13px;color:var(--muted);margin-top:8px}
    .pill{display:inline-block;background:#121a37;border:1px solid #2a3768;padding:4px 8px;border-radius:999px;margin:2px 6px 0 0}
    .right{display:flex;justify-content:flex-end}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HLC Daily Progress Report</h1>

    <!-- Header / Meta -->
    <div class="card">
      <div class="row">
        <div class="field">
          <label>Date</label>
          <input id="d_date" type="date">
        </div>
        <div class="field">
          <label>Shift</label>
          <select id="d_shift">
            <option value="Day">Day</option>
            <option value="Night">Night</option>
          </select>
        </div>
        <div class="field">
          <label>Weather</label>
          <input id="d_weather" placeholder="Sunny / Cloudy / Rainy…">
        </div>
        <div class="field">
          <label>Engineer’s Name</label>
          <input id="d_engineer" placeholder="Enter reporting engineer/supervisor">
        </div>
      </div>
    </div>

    <!-- Equipment / Machinery Log -->
    <div class="card" id="equipCard">
      <div class="row">
        <div class="field"><label>Equipment / Machinery Log</label></div>
      </div>
      <table id="equipTable" aria-label="Equipment Log">
        <thead>
          <tr>
            <th style="min-width:130px">Machine</th>
            <th>HM Start</th>
            <th>HM End</th>
            <th>HM (hrs)</th>
            <th>Diesel (L)</th>
            <th>Remarks</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="right">Totals:</td>
            <td id="eq_total_hm">0</td>
            <td id="eq_total_diesel">0</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
      <div class="toolbar">
        <button class="btn" id="addEquip">+ Add Equipment</button>
      </div>
      <div class="hint">HM (hour-meter) hours are calculated as <b>End − Start</b> per row and summed here.</div>
    </div>

    <!-- Materials / Transport -->
    <div class="card" id="matCard">
      <div class="row">
        <div class="field"><label>Materials / Transport</label></div>
      </div>
      <table id="matTable" aria-label="Materials">
        <thead>
          <tr>
            <th style="min-width:130px">Material</th>
            <th>Transporter / Source</th>
            <th>Loads</th>
            <th>Qty / Load</th>
            <th>Unit</th>
            <th>Total Qty</th>
            <th>Remarks</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="8">
              <div class="totals">Unit-wise totals: <span id="matTotals"></span></div>
            </td>
          </tr>
        </tfoot>
      </table>
      <div class="toolbar">
        <button class="btn" id="addMat">+ Add Material</button>
      </div>
      <div class="hint">Total Qty = <b>Loads × Qty/Load</b>. We also show combined totals per unit (e.g., t, m³, m²).</div>
    </div>

    <!-- Notes -->
    <div class="card">
      <div class="row">
        <div class="field" style="flex:1 1 100%">
          <label>Additional Notes</label>
          <textarea id="d_notes" placeholder="Any inspections, issues, safety notes, visitors, etc."></textarea>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="saveBtn">Save (local)</button>
        <button class="btn primary" id="printBtn">Print / Share PDF</button>
        <span class="hint">Data auto-saves locally and works offline.</span>
      </div>
    </div>

    <div class="hint">App version: <span id="ver">DPRForm v2 (Engineer + Qty + HM totals)</span></div>
  </div>

  <!-- Row templates -->
  <template id="equipRow">
    <tr>
      <td><input placeholder="Excavator, Paver, JCB…" /></td>
      <td><input type="number" step="0.01" inputmode="decimal" placeholder="Start" class="hmStart" /></td>
      <td><input type="number" step="0.01" inputmode="decimal" placeholder="End" class="hmEnd" /></td>
      <td class="hmHours">0</td>
      <td><input type="number" step="0.01" inputmode="decimal" placeholder="L" class="diesel" /></td>
      <td><input placeholder="Remarks" /></td>
      <td><button class="btn ghost del" title="Delete">✕</button></td>
    </tr>
  </template>

  <template id="matRow">
    <tr>
      <td><input placeholder="Aggregate 40mm, Bitumen, Cement…" /></td>
      <td><input placeholder="Transporter / Source" /></td>
      <td><input type="number" step="1" inputmode="numeric" min="0" class="loads" placeholder="#" /></td>
      <td><input type="number" step="0.01" inputmode="decimal" min="0" class="qtyPer" placeholder="per load" /></td>
      <td>
        <select class="unit">
          <option value="t">t</option>
          <option value="m³">m³</option>
          <option value="m²">m²</option>
          <option value="kg">kg</option>
          <option value="nos">nos</option>
        </select>
      </td>
      <td class="rowTotal">0</td>
      <td><input placeholder="Remarks" /></td>
      <td><button class="btn ghost del" title="Delete">✕</button></td>
    </tr>
  </template>

  <script>
    // --- PWA SW register (kept) ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }

    // ---- helpers ----
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const num = v => isFinite(parseFloat(v)) ? parseFloat(v) : 0;

    // ---- state save/restore ----
    const LS_KEY = 'hlc_dpr_v2';
    function saveLocal(){
      const data = {
        date: $('#d_date').value,
        shift: $('#d_shift').value,
        weather: $('#d_weather').value,
        engineer: $('#d_engineer').value,
        notes: $('#d_notes').value,
        equip: $$('#equipTable tbody tr').map(tr => {
          const [m, s, e, _h, d, r] = $$('td,th', tr);
          return {
            machine: $('input', m).value,
            hmStart: $('input', s).value,
            hmEnd: $('input', e).value,
            diesel: $('input', d).value,
            remarks: $('input', r).value
          };
        }),
        mat: $$('#matTable tbody tr').map(tr => {
          const [mat, src, loads, qper, unit, _tot, rem] = $$('td,th', tr);
          return {
            material: $('input', mat).value,
            source: $('input', src).value,
            loads: $('input', loads).value,
            qtyPer: $('input', qper).value,
            unit: $('select', unit).value,
            remarks: $('input', rem).value
          };
        })
      };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    function restoreLocal(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return addEquipRow(), addMatRow();

      const data = JSON.parse(raw);
      $('#d_date').value = data.date || '';
      $('#d_shift').value = data.shift || 'Day';
      $('#d_weather').value = data.weather || '';
      $('#d_engineer').value = data.engineer || '';
      $('#d_notes').value = data.notes || '';

      // Equip
      if(data.equip && data.equip.length){
        data.equip.forEach(add => addEquipRow(add));
      } else addEquipRow();

      // Mat
      if(data.mat && data.mat.length){
        data.mat.forEach(add => addMatRow(add));
      } else addMatRow();

      recalcAll();
    }

    // ---- Equipment table ----
    function addEquipRow(pref){
      const tr = document.importNode($('#equipRow').content, true).firstElementChild;
      if(pref){
        const [m, s, e, _h, d, r] = $$('td', tr);
        $('input', m).value = pref.machine || '';
        $('.hmStart', tr).value = pref.hmStart || '';
        $('.hmEnd', tr).value = pref.hmEnd || '';
        $('.diesel', tr).value = pref.diesel || '';
        $('input', r).value = pref.remarks || '';
      }
      $('#equipTable tbody').appendChild(tr);
      bindRow(tr);
      recalcEquip();
    }

    function recalcEquip(){
      let totHM = 0, totDiesel = 0;
      $$('#equipTable tbody tr').forEach(tr=>{
        const start = num($('.hmStart', tr).value);
        const end   = num($('.hmEnd', tr).value);
        const hrs = Math.max(0, end - start);
        $('.hmHours', tr).textContent = hrs.toFixed(2);
        totHM += hrs;
        totDiesel += num($('.diesel', tr).value);
      });
      $('#eq_total_hm').textContent = totHM.toFixed(2);
      $('#eq_total_diesel').textContent = totDiesel.toFixed(2);
    }

    // ---- Materials table ----
    function addMatRow(pref){
      const tr = document.importNode($('#matRow').content, true).firstElementChild;
      if(pref){
        const [mat, src, loads, qper, unit, _tot, rem] = $$('td', tr);
        $('input', mat).value = pref.material || '';
        $('input', src).value = pref.source || '';
        $('input', loads).value = pref.loads || '';
        $('input', qper).value = pref.qtyPer || '';
        $('select', unit).value = pref.unit || 't';
        $('input', rem).value = pref.remarks || '';
      }
      $('#matTable tbody').appendChild(tr);
      bindRow(tr);
      recalcMat();
    }

    function recalcMat(){
      // per-row total
      const totals = new Map(); // unit -> total
      $$('#matTable tbody tr').forEach(tr=>{
        const loads = num($('.loads', tr).value);
        const per   = num($('.qtyPer', tr).value);
        const unit  = $('.unit', tr).value || 't';
        const rowTot = loads * per;
        $('.rowTotal', tr).textContent = rowTot ? rowTot.toFixed(2) : '0';
        totals.set(unit, (totals.get(unit)||0) + rowTot);
      });
      // render unit map
      const box = $('#matTotals');
      box.innerHTML = '';
      totals.forEach((v,u)=>{
        const span = document.createElement('span');
        span.className = 'pill';
        span.textContent = `${v.toFixed(2)} ${u}`;
        box.appendChild(span);
      });
    }

    // ---- generic ----
    function bindRow(tr){
      tr.addEventListener('input', ()=>{ recalcAll(); saveLocal(); });
      $('.del', tr)?.addEventListener('click', ()=>{
        tr.remove(); recalcAll(); saveLocal();
      });
    }

    function recalcAll(){ recalcEquip(); recalcMat(); }

    // buttons
    $('#addEquip').addEventListener('click', ()=>{ addEquipRow(); saveLocal(); });
    $('#addMat').addEventListener('click', ()=>{ addMatRow(); saveLocal(); });
    $('#saveBtn').addEventListener('click', ()=>{ saveLocal(); alert('Saved on this device for offline use.'); });
    $('#printBtn').addEventListener('click', ()=>{ window.print(); });

    // autosave meta fields
    ['d_date','d_shift','d_weather','d_engineer','d_notes'].forEach(id=>{
      $('#'+id).addEventListener('input', ()=>saveLocal());
      $('#'+id).addEventListener('change', ()=>saveLocal());
    });

    // defaults
    (function init(){
      // default date today if empty
      const d = $('#d_date');
      if(!d.value){
        const today = new Date().toISOString().slice(0,10);
        d.value = today;
      }
      restoreLocal();
    })();
  </script>
</body>
</html>
